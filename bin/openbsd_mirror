#!/bin/bash
. /etc/openbsd-mirror.conf

cd $TARGET_PATH

declare -A PKG_ARCH_MAP
PKG_ARCH_MAP['arm64']="aarch64"
PKG_ARCH_MAP['amd64']="amd64"

for ARCH in $ARCH_LIST; do
  # Download installation files, kernel, etc
  wget -q -nH -nc -r --no-parent https://cdn.openbsd.org/pub/OpenBSD/$VERSION/$ARCH/ -R $CORE_REJECT

  # Download syspatch directory
  wget -q -nH -nc -r --no-parent https://cdn.openbsd.org/pub/OpenBSD/syspatch/$VERSION/$ARCH/ -R "index.html*"

  # Download packages, filtered with regex.
  wget -q -nH -nc -r --no-parent https://cdn.openbsd.org/pub/OpenBSD/$VERSION/packages/${PKG_ARCH_MAP[$ARCH]}/ --accept-regex ${PKG_FILTER_REGEX[$ARCH]} -R "index.html*"
  wget -q -nH -nc -r --no-parent https://cdn.openbsd.org/pub/OpenBSD/$VERSION/packages-stable/${PKG_ARCH_MAP[$ARCH]}/ --accept-regex ${PKG_FILTER_REGEX[$ARCH]} -R "index.html*"
done

# Copy all newly downloaded files into the diode send path
find . -type f -cmin -30 -exec cp -r {} $DIODE_PATH/{} \;
